–û—Ç–ª–∏—á–Ω–æ. –ù–∏–∂–µ ‚Äî **–ø–æ–ª–Ω—ã–π –ø–µ—Ä–µ—á–µ–Ω—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤ –∏ –º–æ–¥—É–ª–µ–π** –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–ø–∏—Å–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è, —Å—Ç—Ä–æ–≥–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥ –≤–∞—à—É –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:

- ‚úÖ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (—Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è, —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã),  
- ‚úÖ –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ—Å—Ç—å –ª–æ–∫–∞—Ü–∏–π,  
- ‚úÖ friendly-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (FSM + –∫–Ω–æ–ø–∫–∏),  
- ‚úÖ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `central_db`, `local_db_weather`, `process_log_db`,  
- ‚úÖ –∫–æ–Ω—Ç—Ä–æ–ª—å –æ—à–∏–±–æ–∫ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ.

–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω—ã –ø–æ —Å–ª–æ—è–º –∏ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞—é—Ç—Å—è **—Ç–æ—á–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞**, **–≤—Ö–æ–¥–∞–º–∏/–≤—ã—Ö–æ–¥–∞–º–∏** –∏ **—Å–≤—è–∑—è–º–∏ —Å –¥—Ä—É–≥–∏–º–∏ –º–æ–¥—É–ª—è–º–∏**.

---

## üî∑ I. –Ø–¥—Ä–æ: –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã (`core/utils/`)

### 1. `validator.py`
**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª**: —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –∏ –±–∞–∑–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è.
```python
def sanitize_user_input(text: str) -> str:
    """–£–¥–∞–ª—è–µ—Ç –æ–ø–∞—Å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã, –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –¥–ª–∏–Ω—É, —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç HTML."""
    ...

def validate_coordinates(lat: float, lon: float) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç: -90 ‚â§ lat ‚â§ 90, -180 ‚â§ lon ‚â§ 180."""
    ...
```
**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤**: `coordinate_manager.py`, `location_fsm.py`, `_services/`.

---

### 2. `coordinate_manager.py`
**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª**: –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ª–æ–∫–∞—Ü–∏–π.
```python
class LocationResolver:
    def resolve(self, input_text: str) -> CanonicalLocation:
        """–ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–µ–∫—Å—Ç –∏–ª–∏ 'lat,lon' ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç CanonicalLocation."""
        ...

    def resolve_from_coords(self, lat: float, lon: float) -> CanonicalLocation:
        """–¢–æ–ª—å–∫–æ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º (–ø–æ—Å–ª–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏)."""
        ...
```
**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**: `validator.py`, `api_client.py` (–¥–ª—è –≥–µ–æ–∫–æ–¥–µ—Ä–∞), `cache_manager.py`.

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤**: `location_fsm.py`, `weather_handler.py`.

---

### 3. `api_client.py`
**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª**: –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ HTTP-–∑–∞–ø—Ä–æ—Å—ã —Å —Ä–µ—Ç—Ä–∞—è–º–∏.
```python
class WeatherAPIClient:
    def fetch_current(self, lat: float, lon: float) -> dict:
        """–í—ã–∑–æ–≤ OpenWeather/Yr —Å timeout=10s, retry=3."""
        ...

class GeocodingClient:
    def geocode(self, query: str) -> Tuple[float, float]:
        """–í—ã–∑–æ–≤ Nominatim/OpenCage."""
        ...
```
**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤**: `LocationResolver`, `weather_fetcher.py`.

---

### 4. `error_handler.py`
**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª**: —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π.
```python
@contextmanager
def safe_task(task_name: str, user_id: int = None):
    """–õ–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫—É –≤ process_log_db –∏ errors.log –ø—Ä–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–∏."""
    ...
```
**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤**: –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (`location_fsm.py`, `weather_handler.py`).

---

## üî∑ II. –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (`core/db/`)

### 1. `central_db.py`
**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª**: —Ä–∞–±–æ—Ç–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –ª–æ–∫–∞—Ü–∏—è–º–∏.
```python
def create_or_get_user(telegram_id: int) -> User:
    """–°–æ–∑–¥–∞—ë—Ç –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""

def add_user_location(
    user_id: int,
    location_id: str,    # geo:55.7558:37.6176
    display_name: str,
    lat: float,
    lon: float,
    is_default: bool = False
) -> None:
    """–î–æ–±–∞–≤–ª—è–µ—Ç –ª–æ–∫–∞—Ü–∏—é. –ï—Å–ª–∏ is_default=True ‚Äî —Å–Ω–∏–º–∞–µ—Ç —Ñ–ª–∞–≥ —Å –¥—Ä—É–≥–∏—Ö."""

def get_default_location(user_id: int) -> Optional[Location]:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ª–æ–∫–∞—Ü–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é."""

def set_default_location(user_id: int, location_id: str) -> None:
    """–ú–µ–Ω—è–µ—Ç –ª–æ–∫–∞—Ü–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é."""

def get_user_locations(user_id: int) -> List[Location]:
    """–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ª–æ–∫–∞—Ü–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
```
**–°—Ö–µ–º–∞ —Ç–∞–±–ª–∏—Ü—ã `user_locations`**:
```sql
CREATE TABLE user_locations (
    id INTEGER PRIMARY KEY,
    user_id INTEGER NOT NULL,
    location_id TEXT NOT NULL UNIQUE,  -- geo:lat:lon
    display_name TEXT NOT NULL,
    lat REAL NOT NULL,
    lon REAL NOT NULL,
    is_default BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(telegram_id)
);
```

---

### 2. `local_db_weather.py`
**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª**: –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–≥–æ–¥—ã.
```python
def has_fresh_data(lat: float, lon: float, max_age_minutes: int = 15) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ."""

def get_weather(lat: float, lon: float) -> WeatherData:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞."""

def save_weather(lat: float, lon: float,  dict, ttl_hours: int = 24) -> None:
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç, –µ—Å–ª–∏ —Ö—ç—à –¥–∞–Ω–Ω—ã—Ö –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ."""
```
**–°—Ö–µ–º–∞**:
```sql
CREATE TABLE weather_cache (
    cache_key TEXT PRIMARY KEY,  -- weather:current:55.7558:37.6176:2025-12-27
    lat REAL NOT NULL,
    lon REAL NOT NULL,
    data_hash TEXT NOT NULL,     -- —Ö—ç—à JSON-–¥–∞–Ω–Ω—ã—Ö
    data JSON NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP NOT NULL
);
```

---

## üî∑ III. –°–∫—Ä–∏–ø—Ç—ã: –ª–æ–≥–∏–∫–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è (`scripts/weather/`)

### 1. `location_fsm.py`
**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª**: FSM –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–æ–∫–∞—Ü–∏—è–º–∏ (aiogram).
```python
class LocationState(StatesGroup):
    waiting_input = State()

@router.message(Command("locations"))
async def show_locations_menu(message: Message):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ª–æ–∫–∞—Ü–∏–π + –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è."""

@router.callback_query(lambda c: c.data.startswith("loc_set_default:"))
async def set_default_location(callback: CallbackQuery):
    """–ú–µ–Ω—è–µ—Ç –ª–æ–∫–∞—Ü–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é."""

@router.message(LocationState.waiting_input)
async def handle_location_input(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–≤–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏—è –≥–æ—Ä–æ–¥–∞."""
    # ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç LocationResolver.resolve()
    # ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —á–µ—Ä–µ–∑ central_db.add_user_location()
```
**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**: `central_db.py`, `coordinate_manager.py`, `validator.py`.

---

### 2. `weather_handler.py`
**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª**: –æ–±—Ä–∞–±–æ—Ç–∫–∞ `/weather`.
```python
@router.message(Command("weather"))
async def handle_weather_request(message: Message):
    user_id = message.from_user.id
    loc = central_db.get_default_location(user_id)
    if not loc:
        await message.answer("–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –ª–æ–∫–∞—Ü–∏—é: /locations")
        return

    with safe_task("weather_request", user_id):
        if local_db_weather.has_fresh_data(loc.lat, loc.lon):
            data = local_db_weather.get_weather(loc.lat, loc.lon)
        else:
            raw = WeatherAPIClient().fetch_current(loc.lat, loc.lon)
            validator.validate_weather_response(raw)  # ‚Üê –∫–∞—Å—Ç–æ–º–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
            local_db_weather.save_weather(loc.lat, loc.lon, raw)
            data = raw

        text = weather_presenter.format_for_telegram(data, loc.display_name)
        await message.answer(text, parse_mode="HTML")
```
**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**: `local_db_weather.py`, `central_db.py`, `api_client.py`, `weather_presenter.py`.

---

### 3. `_services/weather_presenter.py`
**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª**: –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ.
```python
def format_for_telegram( dict, location_name: str) -> str:
    env = Environment(
        loader=PackageLoader("scripts.weather", "_io/templates"),
        autoescape=True  # ‚Üê –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ!
    )
    template = env.get_template("current_weather.html.j2")
    return template.render(
        location=location_name,
        temp=data["temp"],
        description=data["description"],
        updated=data["dt"]
    )
```

---

### 4. `_io/templates/current_weather.html.j2`
```jinja2
üå°Ô∏è –°–µ–π—á–∞—Å –≤ {{ location }}: {{ "%.1f"|format(temp) }}¬∞C
{% if description %}{{ description|capitalize }}{% endif %}
üìÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ updated|datetime_format }}
üíæ –î–∞–Ω–Ω—ã–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ 15 –º–∏–Ω—É—Ç
```

---

## üî∑ IV. –í–æ—Ä–∫–µ—Ä—ã –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (`workers/`, `core/monitoring/`)

### 1. `cleanup_worker.py`
**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª**: –æ—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö.
```python
def cleanup_weather_cache():
    """–£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å–∏ –∏–∑ weather_cache, –≥–¥–µ expires_at < NOW()."""
    ...

def cleanup_old_logs():
    """–£–¥–∞–ª—è–µ—Ç –ª–æ–≥–∏ —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π."""
    ...
```
**–ó–∞–ø—É—Å–∫**: –ø–æ cron –∏–ª–∏ —á–µ—Ä–µ–∑ `apscheduler`.

---

## üî∑ V. –¢–µ—Å—Ç—ã (`tests/`)

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ unit-—Ç–µ—Å—Ç—ã:
- `test_validator.py` ‚Üí —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –æ–ø–∞—Å–Ω—ã—Ö —Å—Ç—Ä–æ–∫.
- `test_coordinate_manager.py` ‚Üí –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç.
- `test_central_db.py` ‚Üí –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å `is_default`.
- `test_weather_handler.py` ‚Üí –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –ª–æ–∫–∞—Ü–∏–∏.

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç:
- –≠–º—É–ª—è—Ü–∏—è `/start` ‚Üí –≤–≤–æ–¥ ¬´–ú–æ—Å–∫–≤–∞¬ª ‚Üí `/weather` ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞.

---

## üî∑ –°–≤—è–∑–∏ –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ (–¥–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Ç–æ–∫–∞)

```
[Telegram] 
    ‚îÇ
    ‚ñº
location_fsm.py ‚Üí coordinate_manager.py ‚Üí api_client.py (–≥–µ–æ–∫–æ–¥–µ—Ä)
    ‚îÇ                                      ‚îÇ
    ‚ñº                                      ‚ñº
central_db.py ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–∫–∞—Ü–∏–∏)
    ‚îÇ
    ‚ñº
weather_handler.py ‚Üí central_db.py (–ø–æ–ª—É—á–µ–Ω–∏–µ –ª–æ–∫–∞—Ü–∏–∏)
    ‚îÇ
    ‚ñº
local_db_weather.py ‚Üí (–∫—ç—à –µ—Å—Ç—å?) ‚îÄ‚îÄ–ù–µ—Ç‚îÄ‚îÄ‚ñ∫ api_client.py (–ø–æ–≥–æ–¥–∞)
    ‚îÇ                                     ‚îÇ
    ‚ñº                                     ‚ñº
weather_presenter.py ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∫—ç—à)
    ‚îÇ
    ‚ñº
[Telegram reply]
```

---

## üî∑ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å?

1. **`central_db.py`** ‚Äî —Ç–∞–±–ª–∏—Ü—ã `users` –∏ `user_locations`.
2. **`coordinate_manager.py`** ‚Äî `LocationResolver` —Å –≥–µ–æ–∫–æ–¥–µ—Ä–æ–º.
3. **`location_fsm.py`** ‚Äî –±–∞–∑–æ–≤—ã–π FSM –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ª–æ–∫–∞—Ü–∏–∏.
4. **`weather_handler.py`** ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π `/weather` —Å –∫—ç—à–µ–º.

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ ‚Äî —Ç–µ—Å—Ç—ã –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (—à–∞–±–ª–æ–Ω—ã, —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è).

---

–ï—Å–ª–∏ –≤—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ, —è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—é:
- –ø–æ–ª–Ω—ã–π –∫–æ–¥ `LocationResolver` —Å fallback –Ω–∞ OpenCage,
- SQL-—Å—Ö–µ–º—ã –¥–ª—è SQLite/PostgreSQL,
- –ø—Ä–∏–º–µ—Ä FSM-—Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è aiogram 3.x.

–ì–æ—Ç–æ–≤ –∫ –¥–µ—Ç–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.